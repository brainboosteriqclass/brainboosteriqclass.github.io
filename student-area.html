<!doctype html>
<html lang="si">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Student Area ‚Ä¢ Brain Booster IQ Class</title>

  <style>
    :root{
      --bg:#f3f4f6; --card:#fff; --ink:#0b1220; --muted:#5b6472;
      --brand:#111827; --wa:#25D366; --line:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--ink)}
    .top{background:var(--brand);color:#fff;padding:16px}
    .wrap{max-width:980px;margin:0 auto;padding:0 14px}
    nav{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    nav a{color:#fff;text-decoration:none;padding:8px 10px;border:1px solid rgba(255,255,255,.25);border-radius:10px}
    nav a:hover{background:rgba(255,255,255,.12)}
    .card{background:var(--card);border-radius:16px;box-shadow:0 8px 25px rgba(0,0,0,.08);padding:16px;margin:16px 0}
    .muted{color:var(--muted);line-height:1.6}
    .btn{display:inline-block;text-decoration:none;border-radius:12px;padding:10px 14px;font-weight:bold;border:0;cursor:pointer}
    .btn.wa{background:var(--wa);color:#fff}
    .btn.dark{background:#111827;color:#fff}
    input,select{padding:10px 12px;border-radius:12px;border:1px solid #d1d5db;width:100%;max-width:420px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
    th{background:#f9fafb}
    .tag{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px}
    .cols{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media(max-width:900px){.cols{grid-template-columns:1fr}}
    a.dl{color:#111827;text-decoration:none;font-weight:bold}
    a.dl:hover{text-decoration:underline}
    .kpi{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px;margin-top:10px}
    @media(max-width:820px){.kpi{grid-template-columns:1fr 1fr}}
    @media(max-width:520px){.kpi{grid-template-columns:1fr}}
    .kpi .box{border:1px solid var(--line);border-radius:14px;padding:12px}
    .big{font-size:20px;font-weight:800}
    .medal{font-size:18px}
    .pass{display:inline-block;padding:4px 8px;border-radius:999px;background:#ecfdf5;color:#065f46;font-size:12px;font-weight:700}
    .fail{display:inline-block;padding:4px 8px;border-radius:999px;background:#fef2f2;color:#991b1b;font-size:12px;font-weight:700}
    .printOnly{display:none}
    /* Printable A4 page */
    @media print{
      body{background:#fff}
      .top, nav, .noPrint, .btn, input, select{display:none !important}
      .printOnly{display:block}
      .card{box-shadow:none;border:1px solid #ddd}
      .wrap{max-width:100%;padding:0}
      table{font-size:12px}
      th,td{padding:6px}
    }
  </style>
</head>

<body>
<header class="top">
  <div class="wrap">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
      <div>
        <div style="font-size:22px;font-weight:800">Student Area</div>
        <div style="opacity:.85;font-size:13px">Brain Booster IQ Class</div>
      </div>
      <a class="btn wa" href="https://wa.me/94777238519">WhatsApp Help</a>
    </div>

    <nav>
      <a href="index.html">Home</a>
      <a href="about.html">About</a>
      <a href="student-area.html">Student Area</a>
      <a href="contact.html">Contact</a>
    </nav>
  </div>
</header>

<main class="wrap">

  <!-- PRINT HEADER -->
  <div class="printOnly" style="padding:10px 0 0">
    <h2 style="margin:0">Brain Booster IQ Class</h2>
    <div id="printSubtitle" style="margin:6px 0 12px;color:#444"></div>
  </div>

  <div class="cols">

    <!-- Downloads -->
    <section class="card noPrint">
      <h2 style="margin:0 0 8px">üì• Downloads</h2>
      <p class="muted" style="margin:0 0 10px">
        Papers / Worksheets list ‡∂ë‡∂ö <b>data/downloads.json</b> file ‡∂ë‡∂ö edit ‡∂ö‡∂ª‡∂Ω‡∑è update ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.
      </p>
      <div id="downloads"></div>
    </section>

    <!-- Results + Ranking -->
    <section class="card">
      <h2 style="margin:0 0 8px">üèÖ Results & Ranking</h2>

      <!-- Controls -->
      <div class="noPrint" style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end">
        <div style="flex:1;min-width:240px">
          <label class="muted" for="testFilter"><b>Filter by Test</b></label><br>
          <select id="testFilter">
            <option value="ALL">All Tests</option>
          </select>
        </div>

        <div style="flex:1;min-width:240px">
          <label class="muted" for="q"><b>Search</b> (name / index / test)</label><br>
          <input id="q" placeholder="Search (e.g., Nimal / 04 / Test 1)"/>
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn dark" id="printTop20Btn" type="button">üñ®Ô∏è Print Top 20 (A4)</button>
        </div>
      </div>

      <!-- Settings note -->
      <div class="muted" style="margin-top:10px">
        Pass Mark is set to <b id="passLabel"></b>. You can change it inside this file (PASS_MARK).
      </div>

      <!-- KPIs -->
      <div class="kpi" id="kpis"></div>

      <!-- Top 3 -->
      <div class="card" style="margin-top:14px">
        <h3 style="margin:0 0 8px">ü•á Top 3 (Medals)</h3>
        <div id="top3"></div>
      </div>

      <!-- Top 10 Chart (text bar chart) -->
      <div class="card" style="margin-top:14px">
        <h3 style="margin:0 0 8px">üìä Top 10 Chart</h3>
        <div class="muted" style="margin-bottom:10px">Simple bar chart (no libraries). Longer bar = higher marks.</div>
        <div id="top10chart"></div>
      </div>

      <!-- Top 20 -->
      <div class="card" style="margin-top:14px" id="top20Card">
        <h3 style="margin:0 0 8px">üèÜ Ranking (Top 20)</h3>
        <div id="ranking"></div>
      </div>

      <!-- All Results -->
      <div class="card noPrint" style="margin-top:14px">
        <h3 style="margin:0 0 8px">üìã All Results</h3>
        <div id="results"></div>
      </div>
    </section>

  </div>
</main>

<script>
/* ================== SETTINGS (edit here) ================== */
const PASS_MARK = 25;     // pass marks (example 25)
const DEFAULT_OUTOF = 40; // if outof missing in JSON, use this
/* ========================================================== */

async function loadJSON(path){
  const r = await fetch(path, {cache:"no-store"});
  if(!r.ok) throw new Error("Failed to load " + path);
  return await r.json();
}

function renderDownloads(items){
  if(!items.length) return "<div class='muted'>No downloads yet.</div>";
  return items.map(x => `
    <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;padding:10px 0;border-bottom:1px solid #e5e7eb">
      <div>
        <div><a class="dl" href="${x.url}" target="_blank" rel="noopener">${x.title}</a></div>
        <div class="muted" style="font-size:13px">${x.note || ""}</div>
      </div>
      <span class="tag">${x.type || "PDF"}</span>
    </div>
  `).join("");
}

function toNumber(x){
  const n = Number(x);
  return Number.isFinite(n) ? n : 0;
}

function normalizeIndex(ix){
  const n = parseInt(String(ix).replace(/\D/g,""), 10);
  return Number.isFinite(n) ? n : 999999;
}

function scoreRow(r){
  const marks = toNumber(r.marks);
  const outof = Math.max(1, toNumber(r.outof) || DEFAULT_OUTOF);
  const pct = (marks / outof) * 100;
  const pass = marks >= PASS_MARK;
  return { marks, outof, pct, pass };
}

function sortForRanking(a,b){
  const sa = scoreRow(a), sb = scoreRow(b);
  if (sb.marks !== sa.marks) return sb.marks - sa.marks;
  if (sb.pct !== sa.pct) return sb.pct - sa.pct;
  return normalizeIndex(a.index) - normalizeIndex(b.index);
}

function renderResultsTable(rows){
  if(!rows.length) return "<div class='muted' style='margin-top:10px'>No matching results.</div>";
  const head = `
    <table>
      <thead>
        <tr>
          <th>Student</th>
          <th>Index</th>
          <th>Test</th>
          <th>Marks</th>
          <th>%</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
  `;
  const body = rows.map(r => {
    const s = scoreRow(r);
    const status = s.pass ? `<span class="pass">PASS</span>` : `<span class="fail">FAIL</span>`;
    return `
      <tr>
        <td>${r.student}</td>
        <td>${r.index}</td>
        <td>${r.test}</td>
        <td><b>${s.marks}</b> / ${s.outof}</td>
        <td>${s.pct.toFixed(1)}%</td>
        <td>${status}</td>
      </tr>
    `;
  }).join("");
  return head + body + "</tbody></table>";
}

function renderRanking(rows){
  if(!rows.length) return "<div class='muted'>No results for ranking.</div>";
  const ranked = [...rows].sort(sortForRanking).slice(0, 20);

  const head = `
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Student</th>
          <th>Index</th>
          <th>Marks</th>
          <th>%</th>
          <th>Status</th>
          <th>Test</th>
        </tr>
      </thead>
      <tbody>
  `;
  const body = ranked.map((r,i)=>{
    const s = scoreRow(r);
    const status = s.pass ? `<span class="pass">PASS</span>` : `<span class="fail">FAIL</span>`;
    return `
      <tr>
        <td><b>${i+1}</b></td>
        <td>${r.student}</td>
        <td>${r.index}</td>
        <td><b>${s.marks}</b> / ${s.outof}</td>
        <td>${s.pct.toFixed(1)}%</td>
        <td>${status}</td>
        <td>${r.test}</td>
      </tr>
    `;
  }).join("");
  return head + body + "</tbody></table>";
}

function renderTop3(rows){
  if(!rows.length) return "<div class='muted'>No results for Top 3.</div>";
  const ranked = [...rows].sort(sortForRanking).slice(0, 3);
  const medals = ["ü•á","ü•à","ü•â"];

  return ranked.map((r,i)=>{
    const s = scoreRow(r);
    const status = s.pass ? `<span class="pass">PASS</span>` : `<span class="fail">FAIL</span>`;
    return `
      <div style="border:1px solid #e5e7eb;border-radius:14px;padding:12px;margin-top:10px">
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
          <div class="medal"><b>${medals[i]} #${i+1}</b></div>
          <div>${status}</div>
        </div>
        <div style="margin-top:6px">
          <div style="font-size:16px;font-weight:800">${r.student} <span class="muted" style="font-weight:600">(${r.index})</span></div>
          <div class="muted">Test: <b>${r.test}</b></div>
          <div style="margin-top:6px">
            Marks: <b>${s.marks}</b> / ${s.outof} ‚Ä¢ ${s.pct.toFixed(1)}%
          </div>
        </div>
      </div>
    `;
  }).join("");
}

function renderKPIs(rows){
  if(!rows.length) return `<div class="muted">No data for summary.</div>`;

  let totalMarks = 0;
  let totalOutof = 0;
  let passCount = 0;

  let highest = null; // {row, score}
  for(const r of rows){
    const s = scoreRow(r);
    totalMarks += s.marks;
    totalOutof += s.outof;
    if(s.pass) passCount++;

    if(!highest || sortForRanking(r, highest.row) < 0){ // r ranks higher than current highest
      highest = {row:r, score:s};
    }
  }

  const n = rows.length;
  const avgMarks = totalMarks / n;
  const avgPct = (totalMarks / Math.max(1,totalOutof)) * 100;
  const passRate = (passCount / n) * 100;

  const highestText = highest
    ? `${highest.row.student} (${highest.row.index})`
    : "-";

  const highestMarks = highest
    ? `${highest.score.marks}/${highest.score.outof}`
    : "-";

  return `
    <div class="box">
      <div class="muted">Students</div>
      <div class="big">${n}</div>
    </div>
    <div class="box">
      <div class="muted">Average</div>
      <div class="big">${avgMarks.toFixed(1)} / ${DEFAULT_OUTOF}</div>
      <div class="muted">${avgPct.toFixed(1)}%</div>
    </div>
    <div class="box">
      <div class="muted">Pass Rate</div>
      <div class="big">${passRate.toFixed(1)}%</div>
      <div class="muted">${passCount} passed</div>
    </div>
    <div class="box">
      <div class="muted">Class Highest</div>
      <div class="big">${highestMarks}</div>
      <div class="muted">${highestText}</div>
    </div>
  `;
}

function renderTop10Chart(rows){
  if(!rows.length) return "<div class='muted'>No data.</div>";
  const top10 = [...rows].sort(sortForRanking).slice(0, 10);
  const maxMarks = Math.max(...top10.map(r => scoreRow(r).marks), 1);

  return top10.map((r,i)=>{
    const s = scoreRow(r);
    const w = Math.round((s.marks / maxMarks) * 100);
    const medal = (i===0)?"ü•á":(i===1)?"ü•à":(i===2)?"ü•â":"";
    const status = s.pass ? `<span class="pass">PASS</span>` : `<span class="fail">FAIL</span>`;
    return `
      <div style="margin-top:10px">
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
          <div><b>${i+1}.</b> ${medal} ${r.student} <span class="muted">(${r.index})</span></div>
          <div>${status} &nbsp; <b>${s.marks}</b>/${s.outof}</div>
        </div>
        <div style="height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden;margin-top:6px">
          <div style="height:10px;width:${w}%;background:#111827"></div>
        </div>
      </div>
    `;
  }).join("");
}

let ALL_RESULTS = [];
let CURRENT_TEST = "ALL";
let CURRENT_BASE = []; // results after test filter

function byTest(rows){
  return (CURRENT_TEST === "ALL")
    ? rows
    : rows.filter(r => String(r.test) === CURRENT_TEST);
}

function getFilteredForTable(){
  const q = document.getElementById("q").value.trim().toLowerCase();
  const base = CURRENT_BASE;
  if(!q) return base;

  return base.filter(r =>
    (r.student||"").toLowerCase().includes(q) ||
    (r.index||"").toLowerCase().includes(q) ||
    (r.test||"").toLowerCase().includes(q)
  );
}

function refreshUI(){
  CURRENT_BASE = byTest(ALL_RESULTS);         // no search (for ranking/top3/kpi/chart)
  const filtered = getFilteredForTable();     // search affects only all-results table

  document.getElementById("kpis").innerHTML = renderKPIs(CURRENT_BASE);
  document.getElementById("top3").innerHTML = renderTop3(CURRENT_BASE);
  document.getElementById("top10chart").innerHTML = renderTop10Chart(CURRENT_BASE);
  document.getElementById("ranking").innerHTML = renderRanking(CURRENT_BASE);
  document.getElementById("results").innerHTML = renderResultsTable(filtered);

  const testName = (CURRENT_TEST === "ALL") ? "All Tests" : CURRENT_TEST;
  document.getElementById("printSubtitle").textContent =
    `${testName} ‚Ä¢ Pass Mark ${PASS_MARK}/${DEFAULT_OUTOF} ‚Ä¢ Printed: ${new Date().toLocaleDateString()}`;
}

function buildTestFilter(){
  const sel = document.getElementById("testFilter");
  const tests = Array.from(new Set(ALL_RESULTS.map(r=>String(r.test)).filter(Boolean))).sort();
  sel.innerHTML = `<option value="ALL">All Tests</option>` + tests.map(t=>`<option value="${t}">${t}</option>`).join("");
  sel.value = "ALL";
  CURRENT_TEST = "ALL";
}

(async () => {
  document.getElementById("passLabel").textContent = `${PASS_MARK}/${DEFAULT_OUTOF}`;

  try{
    const dls = await loadJSON("data/downloads.json");
    document.getElementById("downloads").innerHTML = renderDownloads(dls);

    ALL_RESULTS = await loadJSON("data/results.json");
    buildTestFilter();
    refreshUI();
  }catch(e){
    document.getElementById("downloads").innerHTML = "<div class='muted'>Cannot load downloads.json</div>";
    document.getElementById("kpis").innerHTML = "<div class='muted'>Cannot load results.json</div>";
    document.getElementById("top3").innerHTML = "<div class='muted'>Cannot load results.json</div>";
    document.getElementById("top10chart").innerHTML = "<div class='muted'>Cannot load results.json</div>";
    document.getElementById("ranking").innerHTML = "<div class='muted'>Cannot load results.json</div>";
    document.getElementById("results").innerHTML = "<div class='muted'>Cannot load results.json</div>";
  }
})();

document.getElementById("q").addEventListener("input", refreshUI);

document.getElementById("testFilter").addEventListener("change", (ev)=>{
  CURRENT_TEST = ev.target.value;
  refreshUI();
});

document.getElementById("printTop20Btn").addEventListener("click", ()=>{
  // For print: we want Top 20 visible, hide downloads & search by CSS @media print
  window.print();
});
</script>
</body>
</html>